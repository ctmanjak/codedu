language: python
python:
  - '3.6'

env:
  - "DB_PASSWORD=travis"

services:
  - mysql
  - docker

before_install:
  - sudo cat /etc/docker/daemon.json
  - mysql -e 'CREATE DATABASE codedu;'

install:
  - pip install -r requirements.txt

script:
  - pytest test

before_deploy:
  - sudo echo '{ "insecure-registries":["15.165.181.246:5000"] }' > /etc/docker/daemon.json
  - sudo systemctl restart docker

deploy:
  provider: script
  script: sudo bash docker-deploy.sh